# OmniTAK Android Auto-Build Pipeline
# GitLab CI/CD configuration for building Android app with Bazel and Rust

variables:
  # Android SDK/NDK Configuration
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  ANDROID_NDK_VERSION: "25.1.8937393"

  # Bazel Configuration
  BAZEL_VERSION: "7.2.1"

  # App Configuration
  ANDROID_PACKAGE_NAME: "com.engindearing.omnitak"
  APP_NAME: "OmniTAK"

  # Build paths
  ANDROID_HOME: "/opt/android-sdk"
  ANDROID_NDK_HOME: "/opt/android-sdk/ndk/${ANDROID_NDK_VERSION}"

  # Gradle/Bazel cache
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"

# Docker image with Android SDK, NDK, and build tools
# Using a comprehensive Android build image
image: mingc/android-build-box:latest

# Define build stages
stages:
  - setup
  - validate
  - build_native
  - build_app
  - test
  - package

# Cache configuration for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .gradle/
    - .bazel-cache/
    - modules/omnitak_mobile/android/native/lib/
    - third-party/

# Setup stage - Install dependencies
setup_environment:
  stage: setup
  script:
    - echo "Setting up build environment..."

    # Install Bazel
    - |
      if ! command -v bazel &> /dev/null; then
        echo "Installing Bazel ${BAZEL_VERSION}..."
        wget https://github.com/bazelbuild/bazel/releases/download/${BAZEL_VERSION}/bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh
        chmod +x bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh
        ./bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh --user
        export PATH="$PATH:$HOME/bin"
      fi

    # Install Rust if not present
    - |
      if ! command -v rustc &> /dev/null; then
        echo "Installing Rust toolchain..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
      fi

    # Add Android targets for Rust
    - echo "Adding Rust Android targets..."
    - rustup target add aarch64-linux-android || true
    - rustup target add armv7-linux-androideabi || true
    - rustup target add x86_64-linux-android || true
    - rustup target add i686-linux-android || true

    # Verify installations
    - bazel version || echo "Bazel not yet in PATH"
    - rustc --version
    - cargo --version

  artifacts:
    paths:
      - bazel-${BAZEL_VERSION}-installer-linux-x86_64.sh
    expire_in: 1 hour
  only:
    - branches
    - tags

# Validate project structure
validate_project:
  stage: validate
  dependencies:
    - setup_environment
  before_script:
    - export PATH="$PATH:$HOME/bin"
  script:
    - echo "Validating project structure..."

    # Check required files
    - test -f BUILD.bazel || (echo "BUILD.bazel not found" && exit 1)
    - test -f .bazelversion || (echo ".bazelversion not found" && exit 1)
    - test -f apps/omnitak_android/BUILD.bazel || (echo "Android app BUILD.bazel not found" && exit 1)
    - test -f modules/omnitak_mobile/android/build.gradle || (echo "Android module build.gradle not found" && exit 1)

    # Check Bazel version matches
    - |
      REQUIRED_BAZEL=$(cat .bazelversion)
      echo "Required Bazel version: $REQUIRED_BAZEL"
      bazel version

    # Verify Android app structure
    - test -f apps/omnitak_android/src/valdi/omnitak_app/App.tsx || (echo "App.tsx not found" && exit 1)
    - test -d apps/omnitak_android/app_assets/android || (echo "Android assets directory not found" && exit 1)

    - echo "✓ Project structure validated successfully"
  only:
    - branches
    - tags

# Build Rust native libraries for Android
build_rust_libraries:
  stage: build_native
  dependencies:
    - setup_environment
  before_script:
    - source $HOME/.cargo/env
    - export PATH="$PATH:$HOME/bin"
    - export ANDROID_NDK_HOME=${ANDROID_NDK_HOME}
  script:
    - echo "Building Rust native libraries for Android..."

    # NOTE: This assumes Rust source is available in the repository
    # If Rust source is in a separate repository (omni-TAK), you need to either:
    # 1. Clone it as part of this CI job, or
    # 2. Pre-build the libraries and store them as artifacts/cache

    # Check if Rust libraries already exist (from cache or previous builds)
    - |
      if [ -f "modules/omnitak_mobile/android/native/lib/arm64-v8a/libomnitak_mobile.a" ]; then
        echo "✓ Rust libraries found in cache, skipping build"
        exit 0
      fi

    # If build script exists, run it
    - |
      if [ -f "modules/omnitak_mobile/build_android.sh" ]; then
        echo "Running build_android.sh..."
        cd modules/omnitak_mobile
        chmod +x build_android.sh

        # Set OMNI_TAK_DIR if Rust source is in repo or mounted
        # export OMNI_TAK_DIR=${CI_PROJECT_DIR}/omni-TAK

        # Run the build script
        # ./build_android.sh || echo "Warning: Rust build script failed - proceeding with cached libraries"

        cd ../..
      else
        echo "Warning: build_android.sh not found - assuming libraries are pre-built"
      fi

    # Verify libraries exist
    - |
      echo "Checking for native libraries..."
      for ABI in arm64-v8a armeabi-v7a x86_64 x86; do
        LIB_PATH="modules/omnitak_mobile/android/native/lib/${ABI}/libomnitak_mobile.a"
        if [ -f "${LIB_PATH}" ]; then
          echo "✓ Found: ${LIB_PATH} ($(du -h ${LIB_PATH} | cut -f1))"
        else
          echo "⚠ Missing: ${LIB_PATH}"
        fi
      done

  artifacts:
    paths:
      - modules/omnitak_mobile/android/native/lib/
    expire_in: 1 day
  cache:
    key: rust-libs-${CI_COMMIT_REF_SLUG}
    paths:
      - modules/omnitak_mobile/android/native/lib/
  only:
    - branches
    - tags

# Build Android APK with Bazel
build_android_apk:
  stage: build_app
  dependencies:
    - validate_project
    - build_rust_libraries
  before_script:
    - export PATH="$PATH:$HOME/bin"
    - export ANDROID_HOME=${ANDROID_HOME}
    - export ANDROID_NDK_HOME=${ANDROID_NDK_HOME}
  script:
    - echo "Building Android APK with Bazel..."

    # Configure Bazel
    - |
      cat > .bazelrc.local << EOF
      build --disk_cache=${CI_PROJECT_DIR}/.bazel-cache
      build --repository_cache=${CI_PROJECT_DIR}/.bazel-cache/repo
      EOF

    # Build the APK
    - |
      echo "Running: bazel build //apps/omnitak_android"
      bazel build //apps/omnitak_android

    # Check build output
    - |
      if [ -f "bazel-bin/apps/omnitak_android/omnitak_android.apk" ]; then
        echo "✓ APK built successfully!"
        ls -lh bazel-bin/apps/omnitak_android/omnitak_android.apk

        # Get APK info
        FILE_SIZE=$(du -h bazel-bin/apps/omnitak_android/omnitak_android.apk | cut -f1)
        echo "APK Size: ${FILE_SIZE}"
      else
        echo "✗ APK not found after build"
        exit 1
      fi

    # Copy APK to a consistent location
    - mkdir -p build-outputs
    - cp bazel-bin/apps/omnitak_android/omnitak_android.apk build-outputs/omnitak-debug.apk

  artifacts:
    name: "omnitak-android-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-outputs/omnitak-debug.apk
      - bazel-bin/apps/omnitak_android/omnitak_android.apk
    expire_in: 1 week
  only:
    - branches
    - tags

# Build release APK (optimized)
build_android_release:
  stage: build_app
  dependencies:
    - validate_project
    - build_rust_libraries
  before_script:
    - export PATH="$PATH:$HOME/bin"
    - export ANDROID_HOME=${ANDROID_HOME}
    - export ANDROID_NDK_HOME=${ANDROID_NDK_HOME}
  script:
    - echo "Building Android APK (Release) with Bazel..."

    # Build optimized APK
    - |
      echo "Running: bazel build -c opt //apps/omnitak_android"
      bazel build -c opt //apps/omnitak_android

    # Copy to output
    - mkdir -p build-outputs
    - cp bazel-bin/apps/omnitak_android/omnitak_android.apk build-outputs/omnitak-release-unsigned.apk

    - echo "✓ Release APK built successfully!"
    - ls -lh build-outputs/omnitak-release-unsigned.apk

  artifacts:
    name: "omnitak-android-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-outputs/omnitak-release-unsigned.apk
    expire_in: 1 month
  only:
    - main
    - master
    - tags

# Run verification script
verify_build:
  stage: test
  dependencies:
    - build_android_apk
  before_script:
    - export PATH="$PATH:$HOME/bin"
  script:
    - echo "Running build verification..."

    # Run verification script if it exists
    - |
      if [ -f "apps/omnitak_android/verify_build.sh" ]; then
        cd apps/omnitak_android
        chmod +x verify_build.sh
        ./verify_build.sh || echo "Verification script failed (non-fatal)"
        cd ../..
      fi

    # Verify APK can be analyzed
    - |
      if command -v aapt &> /dev/null; then
        echo "Analyzing APK..."
        aapt dump badging build-outputs/omnitak-debug.apk | grep -E "package|sdkVersion|targetSdkVersion|application-label"
      fi

  only:
    - branches
    - tags

# Package artifacts and create distribution
package_artifacts:
  stage: package
  dependencies:
    - build_android_apk
    - build_android_release
  script:
    - echo "Packaging build artifacts..."

    # Create distribution package
    - mkdir -p dist
    - |
      if [ -f "build-outputs/omnitak-debug.apk" ]; then
        cp build-outputs/omnitak-debug.apk dist/
      fi
    - |
      if [ -f "build-outputs/omnitak-release-unsigned.apk" ]; then
        cp build-outputs/omnitak-release-unsigned.apk dist/
      fi

    # Create build info
    - |
      cat > dist/BUILD_INFO.txt << EOF
      Build Information
      =================
      Commit: ${CI_COMMIT_SHA}
      Branch: ${CI_COMMIT_REF_NAME}
      Tag: ${CI_COMMIT_TAG}
      Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
      Pipeline: ${CI_PIPELINE_ID}

      Package: ${ANDROID_PACKAGE_NAME}
      App Name: ${APP_NAME}
      Target SDK: ${ANDROID_COMPILE_SDK}
      EOF

    - echo "Package contents:"
    - ls -lh dist/
    - cat dist/BUILD_INFO.txt

  artifacts:
    name: "omnitak-android-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/
    expire_in: 1 month
  only:
    - branches
    - tags

# Optional: Deploy to internal distribution (configure as needed)
# deploy_internal:
#   stage: deploy
#   dependencies:
#     - package_artifacts
#   script:
#     - echo "Deploying to internal distribution..."
#     # Add deployment commands here (e.g., upload to Firebase App Distribution, S3, etc.)
#   only:
#     - main
#     - tags
#   when: manual
